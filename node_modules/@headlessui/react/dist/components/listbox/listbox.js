"use client";import{useFocusRing as Ae}from"@react-aria/focus";import{useHover as Re}from"@react-aria/interactions";import D,{Fragment as fe,createContext as ie,createRef as he,useCallback as be,useContext as re,useEffect as De,useMemo as B,useReducer as _e,useRef as le}from"react";import{flushSync as U}from"react-dom";import{useActivePress as Ie}from'../../hooks/use-active-press.js';import{useByComparator as Ce}from'../../hooks/use-by-comparator.js';import{useControllable as Fe}from'../../hooks/use-controllable.js';import{useDefaultValue as Me}from'../../hooks/use-default-value.js';import{useDidElementMove as Be}from'../../hooks/use-did-element-move.js';import{useDisposables as Te}from'../../hooks/use-disposables.js';import{useElementSize as we}from'../../hooks/use-element-size.js';import{useEvent as T}from'../../hooks/use-event.js';import{useId as ae}from'../../hooks/use-id.js';import{useInertOthers as ke}from'../../hooks/use-inert-others.js';import{useIsoMorphicEffect as se}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ue}from'../../hooks/use-latest-value.js';import{useOnDisappear as Ne}from'../../hooks/use-on-disappear.js';import{useOutsideClick as He}from'../../hooks/use-outside-click.js';import{useOwnerDocument as Ge}from'../../hooks/use-owner.js';import{useResolveButtonType as Ve}from'../../hooks/use-resolve-button-type.js';import{useScrollLock as Ke}from'../../hooks/use-scroll-lock.js';import{useSyncRefs as K}from'../../hooks/use-sync-refs.js';import{useTextValue as je}from'../../hooks/use-text-value.js';import{useTrackedPointer as ze}from'../../hooks/use-tracked-pointer.js';import{transitionDataAttributes as We,useTransition as Qe}from'../../hooks/use-transition.js';import{useDisabled as Xe}from'../../internal/disabled.js';import{FloatingProvider as Je,useFloatingPanel as $e,useFloatingPanelProps as qe,useFloatingReference as Ye,useFloatingReferenceProps as Ze,useResolvedAnchor as et}from'../../internal/floating.js';import{FormFields as tt}from'../../internal/form-fields.js';import{useFrozenData as ot}from'../../internal/frozen.js';import{useProvidedId as nt}from'../../internal/id.js';import{OpenClosedProvider as it,State as $,useOpenClosed as rt}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as lt}from'../../utils/bugs.js';import{Focus as g,calculateActiveIndex as pe}from'../../utils/calculate-active-index.js';import{disposables as at}from'../../utils/disposables.js';import{Focus as me,FocusableMode as st,focusFrom as pt,isFocusableElement as ut,sortByDomNode as dt}from'../../utils/focus-management.js';import{attemptSubmit as ct}from'../../utils/form.js';import{match as V}from'../../utils/match.js';import{getOwnerDocument as ft}from'../../utils/owner.js';import{RenderFeatures as xe,forwardRefWithAs as j,mergeProps as Oe,render as z}from'../../utils/render.js';import{useDescribedBy as bt}from'../description/description.js';import{Keys as E}from'../keyboard.js';import{Label as Tt,useLabelledBy as mt,useLabels as xt}from'../label/label.js';import{Portal as Ot}from'../portal/portal.js';var yt=(o=>(o[o.Open=0]="Open",o[o.Closed=1]="Closed",o))(yt||{}),vt=(o=>(o[o.Single=0]="Single",o[o.Multi=1]="Multi",o))(vt||{}),gt=(o=>(o[o.Pointer=0]="Pointer",o[o.Other=1]="Other",o))(gt||{}),Lt=(n=>(n[n.OpenListbox=0]="OpenListbox",n[n.CloseListbox=1]="CloseListbox",n[n.GoToOption=2]="GoToOption",n[n.Search=3]="Search",n[n.ClearSearch=4]="ClearSearch",n[n.RegisterOption=5]="RegisterOption",n[n.UnregisterOption=6]="UnregisterOption",n[n.SetButtonElement=7]="SetButtonElement",n[n.SetOptionsElement=8]="SetOptionsElement",n))(Lt||{});function ue(e,i=o=>o){let o=e.activeOptionIndex!==null?e.options[e.activeOptionIndex]:null,r=dt(i(e.options.slice()),x=>x.dataRef.current.domRef.current),a=o?r.indexOf(o):null;return a===-1&&(a=null),{options:r,activeOptionIndex:a}}let St={[1](e){return e.dataRef.current.disabled||e.listboxState===1?e:{...e,activeOptionIndex:null,listboxState:1,__demoMode:!1}},[0](e){if(e.dataRef.current.disabled||e.listboxState===0)return e;let i=e.activeOptionIndex,{isSelected:o}=e.dataRef.current,r=e.options.findIndex(a=>o(a.dataRef.current.value));return r!==-1&&(i=r),{...e,listboxState:0,activeOptionIndex:i,__demoMode:!1}},[2](e,i){var x,y,p,s,n;if(e.dataRef.current.disabled||e.listboxState===1)return e;let o={...e,searchQuery:"",activationTrigger:(x=i.trigger)!=null?x:1,__demoMode:!1};if(i.focus===g.Nothing)return{...o,activeOptionIndex:null};if(i.focus===g.Specific)return{...o,activeOptionIndex:e.options.findIndex(t=>t.id===i.id)};if(i.focus===g.Previous){let t=e.activeOptionIndex;if(t!==null){let u=e.options[t].dataRef.current.domRef,m=pe(i,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:b=>b.id,resolveDisabled:b=>b.dataRef.current.disabled});if(m!==null){let b=e.options[m].dataRef.current.domRef;if(((y=u.current)==null?void 0:y.previousElementSibling)===b.current||((p=b.current)==null?void 0:p.previousElementSibling)===null)return{...o,activeOptionIndex:m}}}}else if(i.focus===g.Next){let t=e.activeOptionIndex;if(t!==null){let u=e.options[t].dataRef.current.domRef,m=pe(i,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:b=>b.id,resolveDisabled:b=>b.dataRef.current.disabled});if(m!==null){let b=e.options[m].dataRef.current.domRef;if(((s=u.current)==null?void 0:s.nextElementSibling)===b.current||((n=b.current)==null?void 0:n.nextElementSibling)===null)return{...o,activeOptionIndex:m}}}}let r=ue(e),a=pe(i,{resolveItems:()=>r.options,resolveActiveIndex:()=>r.activeOptionIndex,resolveId:t=>t.id,resolveDisabled:t=>t.dataRef.current.disabled});return{...o,...r,activeOptionIndex:a}},[3]:(e,i)=>{if(e.dataRef.current.disabled||e.listboxState===1)return e;let r=e.searchQuery!==""?0:1,a=e.searchQuery+i.value.toLowerCase(),y=(e.activeOptionIndex!==null?e.options.slice(e.activeOptionIndex+r).concat(e.options.slice(0,e.activeOptionIndex+r)):e.options).find(s=>{var n;return!s.dataRef.current.disabled&&((n=s.dataRef.current.textValue)==null?void 0:n.startsWith(a))}),p=y?e.options.indexOf(y):-1;return p===-1||p===e.activeOptionIndex?{...e,searchQuery:a}:{...e,searchQuery:a,activeOptionIndex:p,activationTrigger:1}},[4](e){return e.dataRef.current.disabled||e.listboxState===1||e.searchQuery===""?e:{...e,searchQuery:""}},[5]:(e,i)=>{let o={id:i.id,dataRef:i.dataRef},r=ue(e,a=>[...a,o]);return e.activeOptionIndex===null&&e.dataRef.current.isSelected(i.dataRef.current.value)&&(r.activeOptionIndex=r.options.indexOf(o)),{...e,...r}},[6]:(e,i)=>{let o=ue(e,r=>{let a=r.findIndex(x=>x.id===i.id);return a!==-1&&r.splice(a,1),r});return{...e,...o,activationTrigger:1}},[7]:(e,i)=>e.buttonElement===i.element?e:{...e,buttonElement:i.element},[8]:(e,i)=>e.optionsElement===i.element?e:{...e,optionsElement:i.element}},de=ie(null);de.displayName="ListboxActionsContext";function q(e){let i=re(de);if(i===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,q),o}return i}let Y=ie(null);Y.displayName="ListboxDataContext";function W(e){let i=re(Y);if(i===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,W),o}return i}function Et(e,i){return V(i.type,St,e,i)}let Pt=fe;function At(e,i){var ce;let o=Xe(),{value:r,defaultValue:a,form:x,name:y,onChange:p,by:s,invalid:n=!1,disabled:t=o||!1,horizontal:u=!1,multiple:m=!1,__demoMode:b=!1,...A}=e;const w=u?"horizontal":"vertical";let k=K(i),_=Me(a),[v=m?[]:void 0,P]=Fe(r,p,_),[R,O]=_e(Et,{dataRef:he(),listboxState:b?0:1,options:[],searchQuery:"",activeOptionIndex:null,activationTrigger:1,optionsVisible:!1,buttonElement:null,optionsElement:null,__demoMode:b}),M=le({static:!1,hold:!1}),F=le(new Map),d=Ce(s),h=be(f=>V(c.mode,{[1]:()=>v.some(S=>d(S,f)),[0]:()=>d(v,f)}),[v]),c=B(()=>({...R,value:v,disabled:t,invalid:n,mode:m?1:0,orientation:w,compare:d,isSelected:h,optionsPropsRef:M,listRef:F}),[v,t,n,m,R,F]);se(()=>{R.dataRef.current=c},[c]);let L=c.listboxState===0;He(L,[c.buttonElement,c.optionsElement],(f,S)=>{var C;O({type:1}),ut(S,st.Loose)||(f.preventDefault(),(C=c.buttonElement)==null||C.focus())});let N=B(()=>({open:c.listboxState===0,disabled:t,invalid:n,value:v}),[c,t,v,n]),Z=T(f=>{let S=c.options.find(C=>C.id===f);S&&H(S.dataRef.current.value)}),Q=T(()=>{if(c.activeOptionIndex!==null){let{dataRef:f,id:S}=c.options[c.activeOptionIndex];H(f.current.value),O({type:2,focus:g.Specific,id:S})}}),ee=T(()=>O({type:0})),te=T(()=>O({type:1})),X=Te(),oe=T((f,S,C)=>{X.dispose(),X.microTask(()=>f===g.Specific?O({type:2,focus:g.Specific,id:S,trigger:C}):O({type:2,focus:f,trigger:C}))}),J=T((f,S)=>(O({type:5,id:f,dataRef:S}),()=>O({type:6,id:f}))),H=T(f=>V(c.mode,{[0](){return P==null?void 0:P(f)},[1](){let S=c.value.slice(),C=S.findIndex(Pe=>d(Pe,f));return C===-1?S.push(f):S.splice(C,1),P==null?void 0:P(S)}})),l=T(f=>O({type:3,value:f})),I=T(()=>O({type:4})),G=T(f=>{O({type:7,element:f})}),ne=T(f=>{O({type:8,element:f})}),ve=B(()=>({onChange:H,registerOption:J,goToOption:oe,closeListbox:te,openListbox:ee,selectActiveOption:Q,selectOption:Z,search:l,clearSearch:I,setButtonElement:G,setOptionsElement:ne}),[]),[ge,Le]=xt({inherit:!0}),Se={ref:k},Ee=be(()=>{if(_!==void 0)return P==null?void 0:P(_)},[P,_]);return D.createElement(Le,{value:ge,props:{htmlFor:(ce=c.buttonElement)==null?void 0:ce.id},slot:{open:c.listboxState===0,disabled:t}},D.createElement(Je,null,D.createElement(de.Provider,{value:ve},D.createElement(Y.Provider,{value:c},D.createElement(it,{value:V(c.listboxState,{[0]:$.Open,[1]:$.Closed})},y!=null&&v!=null&&D.createElement(tt,{disabled:t,data:{[y]:v},form:x,onReset:Ee}),z({ourProps:Se,theirProps:A,slot:N,defaultTag:Pt,name:"Listbox"}))))))}let Rt="button";function ht(e,i){var c;let o=W("Listbox.Button"),r=q("Listbox.Button"),a=ae(),x=nt(),{id:y=x||`headlessui-listbox-button-${a}`,disabled:p=o.disabled||!1,autoFocus:s=!1,...n}=e,t=K(i,Ye(),r.setButtonElement),u=Ze(),m=T(L=>{switch(L.key){case E.Enter:ct(L.currentTarget);break;case E.Space:case E.ArrowDown:L.preventDefault(),U(()=>r.openListbox()),o.value||r.goToOption(g.First);break;case E.ArrowUp:L.preventDefault(),U(()=>r.openListbox()),o.value||r.goToOption(g.Last);break}}),b=T(L=>{switch(L.key){case E.Space:L.preventDefault();break}}),A=T(L=>{var N;if(lt(L.currentTarget))return L.preventDefault();o.listboxState===0?(U(()=>r.closeListbox()),(N=o.buttonElement)==null||N.focus({preventScroll:!0})):(L.preventDefault(),r.openListbox())}),w=T(L=>L.preventDefault()),k=mt([y]),_=bt(),{isFocusVisible:v,focusProps:P}=Ae({autoFocus:s}),{isHovered:R,hoverProps:O}=Re({isDisabled:p}),{pressed:M,pressProps:F}=Ie({disabled:p}),d=B(()=>({open:o.listboxState===0,active:M||o.listboxState===0,disabled:p,invalid:o.invalid,value:o.value,hover:R,focus:v,autofocus:s}),[o.listboxState,o.value,p,R,v,M,o.invalid,s]),h=Oe(u(),{ref:t,id:y,type:Ve(e,o.buttonElement),"aria-haspopup":"listbox","aria-controls":(c=o.optionsElement)==null?void 0:c.id,"aria-expanded":o.listboxState===0,"aria-labelledby":k,"aria-describedby":_,disabled:p||void 0,autoFocus:s,onKeyDown:m,onKeyUp:b,onKeyPress:w,onClick:A},P,O,F);return z({ourProps:h,theirProps:n,slot:d,defaultTag:Rt,name:"Listbox.Button"})}let ye=ie(!1),Dt="div",_t=xe.RenderStrategy|xe.Static;function It(e,i){var J,H;let o=ae(),{id:r=`headlessui-listbox-options-${o}`,anchor:a,portal:x=!1,modal:y=!0,transition:p=!1,...s}=e,n=et(a);n&&(x=!0);let t=W("Listbox.Options"),u=q("Listbox.Options"),m=Ge(t.optionsElement),b=rt(),[A,w]=Qe(p,t.optionsElement,b!==null?(b&$.Open)===$.Open:t.listboxState===0);Ne(A,t.buttonElement,u.closeListbox);let k=t.__demoMode?!1:y&&t.listboxState===0;Ke(k,m);let _=t.__demoMode?!1:y&&t.listboxState===0;ke(_,{allowed:T(()=>[t.buttonElement,t.optionsElement])});let v=t.listboxState!==0,R=Be(v,t.buttonElement)?!1:A,O=A&&t.listboxState===1,M=ot(O,t.value),F=T(l=>t.compare(M,l)),d=B(()=>{var I;if(n==null||!((I=n==null?void 0:n.to)!=null&&I.includes("selection")))return null;let l=t.options.findIndex(G=>F(G.dataRef.current.value));return l===-1&&(l=0),l},[n,t.options]),h=(()=>{if(n==null)return;if(d===null)return{...n,inner:void 0};let l=Array.from(t.listRef.current.values());return{...n,inner:{listRef:{current:l},index:d}}})(),[c,L]=$e(h),N=qe(),Z=K(i,n?c:null,u.setOptionsElement),Q=Te();De(()=>{var I;let l=t.optionsElement;l&&t.listboxState===0&&l!==((I=ft(l))==null?void 0:I.activeElement)&&(l==null||l.focus({preventScroll:!0}))},[t.listboxState,t.optionsElement]);let ee=T(l=>{var I,G;switch(Q.dispose(),l.key){case E.Space:if(t.searchQuery!=="")return l.preventDefault(),l.stopPropagation(),u.search(l.key);case E.Enter:if(l.preventDefault(),l.stopPropagation(),t.activeOptionIndex!==null){let{dataRef:ne}=t.options[t.activeOptionIndex];u.onChange(ne.current.value)}t.mode===0&&(U(()=>u.closeListbox()),(I=t.buttonElement)==null||I.focus({preventScroll:!0}));break;case V(t.orientation,{vertical:E.ArrowDown,horizontal:E.ArrowRight}):return l.preventDefault(),l.stopPropagation(),u.goToOption(g.Next);case V(t.orientation,{vertical:E.ArrowUp,horizontal:E.ArrowLeft}):return l.preventDefault(),l.stopPropagation(),u.goToOption(g.Previous);case E.Home:case E.PageUp:return l.preventDefault(),l.stopPropagation(),u.goToOption(g.First);case E.End:case E.PageDown:return l.preventDefault(),l.stopPropagation(),u.goToOption(g.Last);case E.Escape:l.preventDefault(),l.stopPropagation(),U(()=>u.closeListbox()),(G=t.buttonElement)==null||G.focus({preventScroll:!0});return;case E.Tab:l.preventDefault(),l.stopPropagation(),U(()=>u.closeListbox()),pt(t.buttonElement,l.shiftKey?me.Previous:me.Next);break;default:l.key.length===1&&(u.search(l.key),Q.setTimeout(()=>u.clearSearch(),350));break}}),te=(J=t.buttonElement)==null?void 0:J.id,X=B(()=>({open:t.listboxState===0}),[t.listboxState]),oe=Oe(n?N():{},{id:r,ref:Z,"aria-activedescendant":t.activeOptionIndex===null||(H=t.options[t.activeOptionIndex])==null?void 0:H.id,"aria-multiselectable":t.mode===1?!0:void 0,"aria-labelledby":te,"aria-orientation":t.orientation,onKeyDown:ee,role:"listbox",tabIndex:t.listboxState===0?0:void 0,style:{...s.style,...L,"--button-width":we(t.buttonElement,!0).width},...We(w)});return D.createElement(Ot,{enabled:x?e.static||A:!1},D.createElement(Y.Provider,{value:t.mode===1?t:{...t,isSelected:F}},z({ourProps:oe,theirProps:s,slot:X,defaultTag:Dt,features:_t,visible:R,name:"Listbox.Options"})))}let Ct="div";function Ft(e,i){let o=ae(),{id:r=`headlessui-listbox-option-${o}`,disabled:a=!1,value:x,...y}=e,p=re(ye)===!0,s=W("Listbox.Option"),n=q("Listbox.Option"),t=s.activeOptionIndex!==null?s.options[s.activeOptionIndex].id===r:!1,u=s.isSelected(x),m=le(null),b=je(m),A=Ue({disabled:a,value:x,domRef:m,get textValue(){return b()}}),w=K(i,m,d=>{d?s.listRef.current.set(r,d):s.listRef.current.delete(r)});se(()=>{if(!s.__demoMode&&s.listboxState===0&&t&&s.activationTrigger!==0)return at().requestAnimationFrame(()=>{var d,h;(h=(d=m.current)==null?void 0:d.scrollIntoView)==null||h.call(d,{block:"nearest"})})},[m,t,s.__demoMode,s.listboxState,s.activationTrigger,s.activeOptionIndex]),se(()=>{if(!p)return n.registerOption(r,A)},[A,r,p]);let k=T(d=>{var h;if(a)return d.preventDefault();n.onChange(x),s.mode===0&&(U(()=>n.closeListbox()),(h=s.buttonElement)==null||h.focus({preventScroll:!0}))}),_=T(()=>{if(a)return n.goToOption(g.Nothing);n.goToOption(g.Specific,r)}),v=ze(),P=T(d=>{v.update(d),!a&&(t||n.goToOption(g.Specific,r,0))}),R=T(d=>{v.wasMoved(d)&&(a||t||n.goToOption(g.Specific,r,0))}),O=T(d=>{v.wasMoved(d)&&(a||t&&n.goToOption(g.Nothing))}),M=B(()=>({active:t,focus:t,selected:u,disabled:a,selectedOption:u&&p}),[t,u,a,p]),F=p?{}:{id:r,ref:w,role:"option",tabIndex:a===!0?void 0:-1,"aria-disabled":a===!0?!0:void 0,"aria-selected":u,disabled:void 0,onClick:k,onFocus:_,onPointerEnter:P,onMouseEnter:P,onPointerMove:R,onMouseMove:R,onPointerLeave:O,onMouseLeave:O};return!u&&p?null:z({ourProps:F,theirProps:y,slot:M,defaultTag:Ct,name:"Listbox.Option"})}let Mt=fe;function Bt(e,i){let{options:o,placeholder:r,...a}=e,y={ref:K(i)},p=W("ListboxSelectedOption"),s=B(()=>({}),[]),n=p.value===void 0||p.value===null||p.mode===1&&Array.isArray(p.value)&&p.value.length===0;return D.createElement(ye.Provider,{value:!0},z({ourProps:y,theirProps:{...a,children:D.createElement(D.Fragment,null,r&&n?r:o)},slot:s,defaultTag:Mt,name:"ListboxSelectedOption"}))}let wt=j(At),kt=j(ht),Ut=Tt,Nt=j(It),Ht=j(Ft),Gt=j(Bt),Co=Object.assign(wt,{Button:kt,Label:Ut,Options:Nt,Option:Ht,SelectedOption:Gt});export{Co as Listbox,kt as ListboxButton,Ut as ListboxLabel,Ht as ListboxOption,Nt as ListboxOptions,Gt as ListboxSelectedOption};
