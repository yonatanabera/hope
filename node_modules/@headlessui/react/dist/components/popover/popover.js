"use client";import{useFocusRing as Oe}from"@react-aria/focus";import{useHover as Le}from"@react-aria/interactions";import y,{createContext as te,createRef as ie,useContext as oe,useEffect as re,useMemo as I,useReducer as Ie,useRef as Z,useState as de}from"react";import{useActivePress as De}from'../../hooks/use-active-press.js';import{useElementSize as he}from'../../hooks/use-element-size.js';import{useEvent as S}from'../../hooks/use-event.js';import{useEventListener as ke}from'../../hooks/use-event-listener.js';import{useId as ne}from'../../hooks/use-id.js';import{useIsoMorphicEffect as Ge}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Se}from'../../hooks/use-latest-value.js';import{useOnDisappear as He}from'../../hooks/use-on-disappear.js';import{useOutsideClick as Ue}from'../../hooks/use-outside-click.js';import{useOwnerDocument as Pe}from'../../hooks/use-owner.js';import{useResolveButtonType as Ne}from'../../hooks/use-resolve-button-type.js';import{MainTreeProvider as Ae,useMainTreeNode as we,useRootContainers as Ke}from'../../hooks/use-root-containers.js';import{useScrollLock as We}from'../../hooks/use-scroll-lock.js';import{optionalRef as je,useSyncRefs as X}from'../../hooks/use-sync-refs.js';import{Direction as h,useTabDirection as Ce}from'../../hooks/use-tab-direction.js';import{transitionDataAttributes as Be,useTransition as Re}from'../../hooks/use-transition.js';import{CloseProvider as Ve}from'../../internal/close-provider.js';import{FloatingProvider as $e,useFloatingPanel as Je,useFloatingPanelProps as Xe,useFloatingReference as qe,useResolvedAnchor as ze}from'../../internal/floating.js';import{Hidden as fe,HiddenFeatures as ce}from'../../internal/hidden.js';import{OpenClosedProvider as Ye,ResetOpenClosedProvider as Qe,State as q,useOpenClosed as _e}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as Fe}from'../../utils/bugs.js';import{Focus as k,FocusResult as ve,FocusableMode as Ze,focusIn as w,getFocusableElements as Te,isFocusableElement as et}from'../../utils/focus-management.js';import{match as K}from'../../utils/match.js';import'../../utils/micro-task.js';import{getOwnerDocument as tt}from'../../utils/owner.js';import{RenderFeatures as le,forwardRefWithAs as z,mergeProps as me,render as ee,useMergeRefsFn as ot}from'../../utils/render.js';import{Keys as W}from'../keyboard.js';import{Portal as rt,useNestedPortals as nt}from'../portal/portal.js';var lt=(P=>(P[P.Open=0]="Open",P[P.Closed=1]="Closed",P))(lt||{}),at=(s=>(s[s.TogglePopover=0]="TogglePopover",s[s.ClosePopover=1]="ClosePopover",s[s.SetButton=2]="SetButton",s[s.SetButtonId=3]="SetButtonId",s[s.SetPanel=4]="SetPanel",s[s.SetPanelId=5]="SetPanelId",s))(at||{});let pt={[0]:t=>({...t,popoverState:K(t.popoverState,{[0]:1,[1]:0}),__demoMode:!1}),[1](t){return t.popoverState===1?t:{...t,popoverState:1,__demoMode:!1}},[2](t,l){return t.button===l.button?t:{...t,button:l.button}},[3](t,l){return t.buttonId===l.buttonId?t:{...t,buttonId:l.buttonId}},[4](t,l){return t.panel===l.panel?t:{...t,panel:l.panel}},[5](t,l){return t.panelId===l.panelId?t:{...t,panelId:l.panelId}}},ye=te(null);ye.displayName="PopoverContext";function ae(t){let l=oe(ye);if(l===null){let P=new Error(`<${t} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(P,ae),P}return l}let pe=te(null);pe.displayName="PopoverAPIContext";function Ee(t){let l=oe(pe);if(l===null){let P=new Error(`<${t} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(P,Ee),P}return l}let be=te(null);be.displayName="PopoverGroupContext";function xe(){return oe(be)}let se=te(null);se.displayName="PopoverPanelContext";function st(){return oe(se)}function ut(t,l){return K(l.type,pt,t,l)}let it="div";function dt(t,l){var c;let{__demoMode:P=!1,...R}=t,T=Z(null),C=X(l,je(o=>{T.current=o})),s=Z([]),n=Ie(ut,{__demoMode:P,popoverState:P?0:1,buttons:s,button:null,buttonId:null,panel:null,panelId:null,beforePanelSentinel:ie(),afterPanelSentinel:ie(),afterButtonSentinel:ie()}),[{popoverState:v,button:d,buttonId:r,panel:u,panelId:_,beforePanelSentinel:m,afterPanelSentinel:E,afterButtonSentinel:i},a]=n,f=Pe((c=T.current)!=null?c:d),L=I(()=>{if(!d||!u)return!1;for(let M of document.querySelectorAll("body > *"))if(Number(M==null?void 0:M.contains(d))^Number(M==null?void 0:M.contains(u)))return!0;let o=Te(),e=o.indexOf(d),p=(e+o.length-1)%o.length,g=(e+1)%o.length,A=o[p],B=o[g];return!u.contains(A)&&!u.contains(B)},[d,u]),F=Se(r),G=Se(_),j=I(()=>({buttonId:F,panelId:G,close:()=>a({type:1})}),[F,G,a]),b=xe(),D=b==null?void 0:b.registerPopover,H=S(()=>{var o;return(o=b==null?void 0:b.isFocusWithinPopoverGroup())!=null?o:(f==null?void 0:f.activeElement)&&((d==null?void 0:d.contains(f.activeElement))||(u==null?void 0:u.contains(f.activeElement)))});re(()=>D==null?void 0:D(j),[D,j]);let[O,V]=nt(),U=we(d),N=Ke({mainTreeNode:U,portals:O,defaultContainers:[d,u]});ke(f==null?void 0:f.defaultView,"focus",o=>{var e,p,g,A,B,M;o.target!==window&&o.target instanceof HTMLElement&&v===0&&(H()||d&&u&&(N.contains(o.target)||(p=(e=m.current)==null?void 0:e.contains)!=null&&p.call(e,o.target)||(A=(g=E.current)==null?void 0:g.contains)!=null&&A.call(g,o.target)||(M=(B=i.current)==null?void 0:B.contains)!=null&&M.call(B,o.target)||a({type:1})))},!0),Ue(v===0,N.resolveContainers,(o,e)=>{a({type:1}),et(e,Ze.Loose)||(o.preventDefault(),d==null||d.focus())});let x=S(o=>{a({type:1});let e=(()=>o?o instanceof HTMLElement?o:"current"in o&&o.current instanceof HTMLElement?o.current:d:d)();e==null||e.focus()}),$=I(()=>({close:x,isPortalled:L}),[x,L]),J=I(()=>({open:v===0,close:x}),[v,x]),Q={ref:C};return y.createElement(Ae,{node:U},y.createElement($e,null,y.createElement(se.Provider,{value:null},y.createElement(ye.Provider,{value:n},y.createElement(pe.Provider,{value:$},y.createElement(Ve,{value:x},y.createElement(Ye,{value:K(v,{[0]:q.Open,[1]:q.Closed})},y.createElement(V,null,ee({ourProps:Q,theirProps:R,slot:J,defaultTag:it,name:"Popover"})))))))))}let Pt="button";function ft(t,l){let P=ne(),{id:R=`headlessui-popover-button-${P}`,disabled:T=!1,autoFocus:C=!1,...s}=t,[n,v]=ae("Popover.Button"),{isPortalled:d}=Ee("Popover.Button"),r=Z(null),u=`headlessui-focus-sentinel-${ne()}`,_=xe(),m=_==null?void 0:_.closeOthers,i=st()!==null;re(()=>{if(!i)return v({type:3,buttonId:R}),()=>{v({type:3,buttonId:null})}},[i,R,v]);let[a]=de(()=>Symbol()),f=X(r,l,qe(),i?null:S(e=>{if(e)n.buttons.current.push(a);else{let p=n.buttons.current.indexOf(a);p!==-1&&n.buttons.current.splice(p,1)}n.buttons.current.length>1&&console.warn("You are already using a <Popover.Button /> but only 1 <Popover.Button /> is supported."),e&&v({type:2,button:e})})),L=X(r,l),F=Pe(r),G=S(e=>{var p,g,A;if(i){if(n.popoverState===1)return;switch(e.key){case W.Space:case W.Enter:e.preventDefault(),(g=(p=e.target).click)==null||g.call(p),v({type:1}),(A=n.button)==null||A.focus();break}}else switch(e.key){case W.Space:case W.Enter:e.preventDefault(),e.stopPropagation(),n.popoverState===1&&(m==null||m(n.buttonId)),v({type:0});break;case W.Escape:if(n.popoverState!==0)return m==null?void 0:m(n.buttonId);if(!r.current||F!=null&&F.activeElement&&!r.current.contains(F.activeElement))return;e.preventDefault(),e.stopPropagation(),v({type:1});break}}),j=S(e=>{i||e.key===W.Space&&e.preventDefault()}),b=S(e=>{var p,g;Fe(e.currentTarget)||T||(i?(v({type:1}),(p=n.button)==null||p.focus()):(e.preventDefault(),e.stopPropagation(),n.popoverState===1&&(m==null||m(n.buttonId)),v({type:0}),(g=n.button)==null||g.focus()))}),D=S(e=>{e.preventDefault(),e.stopPropagation()}),{isFocusVisible:H,focusProps:O}=Oe({autoFocus:C}),{isHovered:V,hoverProps:U}=Le({isDisabled:T}),{pressed:N,pressProps:Y}=De({disabled:T}),x=n.popoverState===0,$=I(()=>({open:x,active:N||x,disabled:T,hover:V,focus:H,autofocus:C}),[x,V,H,N,T,C]),J=Ne(t,n.button),Q=i?me({ref:L,type:J,onKeyDown:G,onClick:b,disabled:T||void 0,autoFocus:C},O,U,Y):me({ref:f,id:n.buttonId,type:J,"aria-expanded":n.popoverState===0,"aria-controls":n.panel?n.panelId:void 0,disabled:T||void 0,autoFocus:C,onKeyDown:G,onKeyUp:j,onClick:b,onMouseDown:D},O,U,Y),c=Ce(),o=S(()=>{let e=n.panel;if(!e)return;function p(){K(c.current,{[h.Forwards]:()=>w(e,k.First),[h.Backwards]:()=>w(e,k.Last)})===ve.Error&&w(Te().filter(A=>A.dataset.headlessuiFocusGuard!=="true"),K(c.current,{[h.Forwards]:k.Next,[h.Backwards]:k.Previous}),{relativeTo:n.button})}p()});return y.createElement(y.Fragment,null,ee({ourProps:Q,theirProps:s,slot:$,defaultTag:Pt,name:"Popover.Button"}),x&&!i&&d&&y.createElement(fe,{id:u,ref:n.afterButtonSentinel,features:ce.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:o}))}let ct="div",vt=le.RenderStrategy|le.Static;function Me(t,l){let P=ne(),{id:R=`headlessui-popover-backdrop-${P}`,transition:T=!1,...C}=t,[{popoverState:s},n]=ae("Popover.Backdrop"),[v,d]=de(null),r=X(l,d),u=_e(),[_,m]=Re(T,v,u!==null?(u&q.Open)===q.Open:s===0),E=S(f=>{if(Fe(f.currentTarget))return f.preventDefault();n({type:1})}),i=I(()=>({open:s===0}),[s]),a={ref:r,id:R,"aria-hidden":!0,onClick:E,...Be(m)};return ee({ourProps:a,theirProps:C,slot:i,defaultTag:ct,features:vt,visible:_,name:"Popover.Backdrop"})}let Tt="div",mt=le.RenderStrategy|le.Static;function yt(t,l){let P=ne(),{id:R=`headlessui-popover-panel-${P}`,focus:T=!1,anchor:C,portal:s=!1,modal:n=!1,transition:v=!1,...d}=t,[r,u]=ae("Popover.Panel"),{close:_,isPortalled:m}=Ee("Popover.Panel"),E=`headlessui-focus-sentinel-before-${P}`,i=`headlessui-focus-sentinel-after-${P}`,a=Z(null),f=ze(C),[L,F]=Je(f),G=Xe();f&&(s=!0);let j=X(a,l,f?L:null,S(c=>u({type:4,panel:c}))),b=Pe(a),D=ot();Ge(()=>(u({type:5,panelId:R}),()=>{u({type:5,panelId:null})}),[R,u]);let H=_e(),[O,V]=Re(v,r.panel,H!==null?(H&q.Open)===q.Open:r.popoverState===0);He(O,r.button,()=>{u({type:1})});let U=r.__demoMode?!1:n&&O;We(U,b);let N=S(c=>{var o;switch(c.key){case W.Escape:if(r.popoverState!==0||!a.current||b!=null&&b.activeElement&&!a.current.contains(b.activeElement))return;c.preventDefault(),c.stopPropagation(),u({type:1}),(o=r.button)==null||o.focus();break}});re(()=>{var c;t.static||r.popoverState===1&&((c=t.unmount)==null||c)&&u({type:4,panel:null})},[r.popoverState,t.unmount,t.static,u]),re(()=>{if(r.__demoMode||!T||r.popoverState!==0||!a.current)return;let c=b==null?void 0:b.activeElement;a.current.contains(c)||w(a.current,k.First)},[r.__demoMode,T,a.current,r.popoverState]);let Y=I(()=>({open:r.popoverState===0,close:_}),[r.popoverState,_]),x=me(f?G():{},{ref:j,id:R,onKeyDown:N,onBlur:T&&r.popoverState===0?c=>{var e,p,g,A,B;let o=c.relatedTarget;o&&a.current&&((e=a.current)!=null&&e.contains(o)||(u({type:1}),((g=(p=r.beforePanelSentinel.current)==null?void 0:p.contains)!=null&&g.call(p,o)||(B=(A=r.afterPanelSentinel.current)==null?void 0:A.contains)!=null&&B.call(A,o))&&o.focus({preventScroll:!0})))}:void 0,tabIndex:-1,style:{...d.style,...F,"--button-width":he(r.button,!0).width},...Be(V)}),$=Ce(),J=S(()=>{let c=a.current;if(!c)return;function o(){K($.current,{[h.Forwards]:()=>{var p;w(c,k.First)===ve.Error&&((p=r.afterPanelSentinel.current)==null||p.focus())},[h.Backwards]:()=>{var e;(e=r.button)==null||e.focus({preventScroll:!0})}})}o()}),Q=S(()=>{let c=a.current;if(!c)return;function o(){K($.current,{[h.Forwards]:()=>{var M;if(!r.button)return;let e=Te(),p=e.indexOf(r.button),g=e.slice(0,p+1),B=[...e.slice(p+1),...g];for(let ue of B.slice())if(ue.dataset.headlessuiFocusGuard==="true"||(M=r.panel)!=null&&M.contains(ue)){let ge=B.indexOf(ue);ge!==-1&&B.splice(ge,1)}w(B,k.First,{sorted:!1})},[h.Backwards]:()=>{var p;w(c,k.Previous)===ve.Error&&((p=r.button)==null||p.focus())}})}o()});return y.createElement(Qe,null,y.createElement(se.Provider,{value:R},y.createElement(pe.Provider,{value:{close:_,isPortalled:m}},y.createElement(rt,{enabled:s?t.static||O:!1},O&&m&&y.createElement(fe,{id:E,ref:r.beforePanelSentinel,features:ce.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:J}),ee({mergeRefs:D,ourProps:x,theirProps:d,slot:Y,defaultTag:Tt,features:mt,visible:O,name:"Popover.Panel"}),O&&m&&y.createElement(fe,{id:i,ref:r.afterPanelSentinel,features:ce.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:Q})))))}let Et="div";function bt(t,l){let P=Z(null),R=X(P,l),[T,C]=de([]),s=S(E=>{C(i=>{let a=i.indexOf(E);if(a!==-1){let f=i.slice();return f.splice(a,1),f}return i})}),n=S(E=>(C(i=>[...i,E]),()=>s(E))),v=S(()=>{var a;let E=tt(P);if(!E)return!1;let i=E.activeElement;return(a=P.current)!=null&&a.contains(i)?!0:T.some(f=>{var L,F;return((L=E.getElementById(f.buttonId.current))==null?void 0:L.contains(i))||((F=E.getElementById(f.panelId.current))==null?void 0:F.contains(i))})}),d=S(E=>{for(let i of T)i.buttonId.current!==E&&i.close()}),r=I(()=>({registerPopover:n,unregisterPopover:s,isFocusWithinPopoverGroup:v,closeOthers:d}),[n,s,v,d]),u=I(()=>({}),[]),_=t,m={ref:R};return y.createElement(Ae,null,y.createElement(be.Provider,{value:r},ee({ourProps:m,theirProps:_,slot:u,defaultTag:Et,name:"Popover.Group"})))}let gt=z(dt),St=z(ft),At=z(Me),Ct=z(Me),Bt=z(yt),Rt=z(bt),lo=Object.assign(gt,{Button:St,Backdrop:Ct,Overlay:At,Panel:Bt,Group:Rt});export{lo as Popover,Ct as PopoverBackdrop,St as PopoverButton,Rt as PopoverGroup,At as PopoverOverlay,Bt as PopoverPanel};
